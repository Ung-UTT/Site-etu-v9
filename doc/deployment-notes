Initial deployment notes
========================

Existing setup constraints:
---------------------------
  - Apache --> Passenger :(
  - Debian Squeeze --> Debian :) but Ruby 1.9.2 :/
  - MySQL :(


How-to:
-------
aptitude install ruby1.9.1 ruby1.9.1-dev make g++ # package ruby1.9.1 contains Ruby 1.9.2 ;)

cat > /etc/apache2/sites-available/site-etu <<CONF
<VirtualHost *:80>
    # ServerName etu.utt.fr

    DocumentRoot /var/www/site-etu/public
    <Directory /var/www/site-etu/public>
        Allow from all
        # Options -MultiViews
    </Directory>

    # Temporary ugly /v9 relative root URL
    RackBaseURI /v9
    <Directory /var/www/site-etu/v9>
        Options -MultiViews
    </Directory>

    <LocationMatch "^/v9/assets/.*$">
        # Use of ETag is discouraged when Last-Modified is present
        Header unset ETag
        FileETag None

        # RFC says only cache for 1 year
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </LocationMatch>

    RailsEnv production

    RewriteEngine On
    RewriteCond %{DOCUMENT_ROOT}/maintenance.html -f
    RewriteCond %{REQUEST_FILENAME} !/maintenance.html
    RewriteRule ^.*$ /maintenance.html [L]
</VirtualHost>
CONF

a2enmod headers
a2enmod expires
a2enmod rewrite

gem1.9.1 install bundler --no-ri --no-rdoc
gem1.9.1 install passenger --no-ri --no-rdoc

/var/lib/gems/1.9.1/bin/passenger-install-apache2-module
cat >/etc/apache2/mods-available/passenger.load <<CONF
LoadModule passenger_module /var/lib/gems/1.9.1/gems/passenger-3.0.12/ext/apache2/mod_passenger.so
CONF
cat > /etc/apache2/mods-available/passenger.conf <<CONF
PassengerRoot /var/lib/gems/1.9.1/gems/passenger-3.0.12
PassengerRuby /usr/bin/ruby1.9.1
CONF
cd /etc/apache2/mods-enabled/
ln -s ../mods-available/passenger.load
ln -s ../mods-available/passenger.conf

cd /var/www/site-etu
/var/lib/gems/1.9.1/bin/bundle install --deployment --without test development import
RAILS_ENV=production rake1.9.1 db:drop db:setup db:migrate

mkdir log tmp
chown nobody log tmp

ln -s /var/www/site-etu/public /var/www/site-etu/public/v9

/etc/init.d/apache2 restart

# Enjoy!

